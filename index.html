<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shook Vendor Assistant</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Inter:wght@400;600&display=swap');

    body {
      margin: 0;
      height: 100vh;
      background: radial-gradient(ellipse at center, #2b0b19 0%, #000 100%);
      color: #fff;
      font-family: 'Inter', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 100%;
      max-width: 540px;
      padding: 40px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 0 40px rgba(178, 42, 89, 0.25);
      backdrop-filter: blur(10px);
    }

    h2 {
      text-align: center;
      font-family: 'IBM Plex Mono', monospace;
      font-weight: 600;
      margin-bottom: 28px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    input {
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      color: #fff;
      outline: none;
      transition: all 0.25s ease;
    }

    input:focus {
      border-color: #d12b6a;
      box-shadow: 0 0 6px #d12b6a77;
    }

    button {
      background-color: #d12b6a;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.25s ease;
    }

    button:hover {
      background-color: #b41f57;
    }

    .loader {
      margin: 20px auto 0;
      border: 4px solid rgba(255,255,255,0.2);
      border-top: 4px solid #d12b6a;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      display: none;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .answers {
      margin-top: 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .answer-box {
      background: rgba(255, 255, 255, 0.05);
      border-left: 4px solid #d12b6a;
      padding: 18px 20px;
      border-radius: 10px;
      line-height: 1.6;
      animation: fadeIn 0.5s ease-in;
      white-space: pre-line;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .question {
      font-weight: 600;
      margin-bottom: 6px;
    }

    .answer {
      color: #ffd6e5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üí¨ Shook Vendor Assistant</h2>
    <div class="input-group">
      <input id="question" type="text" placeholder="Ask about invoices, payments, access‚Ä¶" />
      <button id="askBtn" onclick="askQuestion()">Ask</button>
    </div>
    <div class="loader" id="loader"></div>
    <div class="answers" id="answersContainer"></div>
  </div>

<script>
  async function askQuestion() {
    const input = document.getElementById("question");
    const question = input.value.trim();
    const loader = document.getElementById("loader");
    const btn = document.getElementById("askBtn");
    const answersContainer = document.getElementById("answersContainer");

    if (!question) return;

    loader.style.display = "block";
    btn.disabled = true;

    try {
      // Send question to backend
      const askRes = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question }),
      });
      const { questionId } = await askRes.json();

      // Poll for answer
      const answer = await pollForAnswer(questionId);

      // Create new answer element
      const box = document.createElement("div");
      box.className = "answer-box";

      // Fallback message if AI doesn‚Äôt know
      if (!answer || answer.includes("not sure")) {
        const emailId = `email-${Date.now()}`;
        box.innerHTML = `
        Question: ${question}\n\n
        Sorry, I can‚Äôt answer that right now.  
        Your question has been sent to the Shook team, and we‚Äôll get back to you as soon as possible.  
        If you‚Äôd like, you can leave your email below and press <b>Send to Team</b>,  
        and we‚Äôll reply directly to your inbox once we have an answer.  
        You can also contact us anytime at  
        <a href="mailto:ops@shook.digital" style="color:#ffb6c1;">ops@shook.digital</a>.
        
        <br><br>
        <input id="${emailId}" 
               type="email" 
               placeholder="Enter your email" 
               style="margin-top:10px;padding:10px;width:100%;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:white;">
        <button style="margin-top:10px;padding:10px 16px;border:none;border-radius:8px;background-color:#d12b6a;color:white;cursor:pointer;"
                onclick="sendToTeam('${question}','${emailId}')">
          Send to Team
        </button>
        `;
      } else {
        box.innerHTML = `\nQuestion: ${question}\n\nAnswer: ${answer}`;
      }

      // Add new box at the top
      answersContainer.prepend(box);

      // Clear input
      input.value = "";

    } catch (error) {
      const box = document.createElement("div");
      box.className = "answer-box";
      box.textContent = "Error connecting to assistant.";
      answersContainer.prepend(box);
    } finally {
      loader.style.display = "none";
      btn.disabled = false;
    }
  }

  async function pollForAnswer(questionId) {
    const maxAttempts = 30;
    for (let i = 0; i < maxAttempts; i++) {
      const res = await fetch(`/latest-answer/${questionId}`);
      const data = await res.json();
      if (data.answer) return data.answer;
      await new Promise((r) => setTimeout(r, 1000));
    }
    return null;
  }

  // Function to send question + email to n8n webhook
  async function sendToTeam(question, emailInputId) {
    const email = document.getElementById(emailInputId).value.trim();
    if (!email) {
      alert("Please enter your email first.");
      return;
    }

    try {
      await fetch("/send-to-team", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, email }),
      });
      alert("‚úÖ Your question has been sent to the Shook team. Thank you!");
    } catch {
      alert("‚ùå There was an error sending your question. Please try again later.");
    }
  }
</script>
</body>
</html>